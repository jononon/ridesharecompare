<head>
  <link href='//fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
  <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
  <script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <div class="page-header">
    <h1>RideShareCompare</h1>
  </div>
  <div class="panel panel-default">
    <div class="panel-heading">Map</div>
    <div class="panel-body">
      <input id="startSearch" type="text" class="form-control" placeholder="Search for an origin">
      <input id="destSearch" type="text" class="form-control" placeholder="Search for a destination">
      <div id="map" style="height:340px;width:100%;"></div>
        <script>
          function initMap() {

            // Create a map object and specify the DOM element for display.
            var map = new google.maps.Map(document.getElementById('map'), {
              mapTypeControl: true,
              mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                mapTypeIds: [
                  google.maps.MapTypeId.ROADMAP,
                  google.maps.MapTypeId.HYBRID
                ]
              },
              scrollwheel: true,
              zoom: 13
            });

            var originSearchBox = new google.maps.places.SearchBox(document.getElementById('startSearch'));
            var destinationSearchBox = new google.maps.places.SearchBox(document.getElementById('destSearch'));

            var destMarker, originMarker;
            originMarker = new google.maps.Marker({
              map:map,
              draggable: true,
              title: "End"
            });
            destMarker = new google.maps.Marker({
              map:map,
              draggable: true,
              title: "End"
            });
            navigator.geolocation.getCurrentPosition(function(location) {
              var currLoc = {
                lat: location.coords.latitude,
                lng: location.coords.longitude
              };
              map.setCenter(currLoc);
              map.setZoom(15);
              originMarker.setPosition(currLoc);
            });
            google.maps.event.addListener(map, "click", function(event) {
              destMarker.setPosition(event.latLng);
              updateBounds();
              if(originMarker.position != undefined)
                calculateRides(originMarker.position.lat(), originMarker.position.lng(), destMarker.position.lat(), destMarker.position.lng());
            });
            destinationSearchBox.addListener('places_changed', function() {
              var places = destinationSearchBox.getPlaces();

              if (places.length == 0) {
                return;
              }
              places.forEach(function(place){
                destMarker.setPosition(place.geometry.location);
              });

              updateBounds();
              if(originMarker.position != undefined)
                calculateRides(originMarker.position.lat(), originMarker.position.lng(), destMarker.position.lat(), destMarker.position.lng());
            });
            originSearchBox.addListener('places_changed', function() {
              var places = originSearchBox.getPlaces();

              if (places.length == 0) {
                return;
              }
              places.forEach(function(place){
                originMarker.setPosition(place.geometry.location);
              });

              if(destMarker.position != undefined) {
                updateBounds();
                calculateRides(originMarker.position.lat(), originMarker.position.lng(), destMarker.position.lat(), destMarker.position.lng());
              }
            });
            map.addListener('bounds_changed', function() {
              destinationSearchBox.setBounds(map.getBounds());
            });
            originMarker.addListener('mouseup', function() {
              if(destMarker.position != undefined) {
                updateBounds();
                calculateRides(originMarker.position.lat(), originMarker.position.lng(), destMarker.position.lat(), destMarker.position.lng());
              }
            });
            destMarker.addListener('mouseup', function() {
              updateBounds();
              if(originMarker.position != undefined)
                calculateRides(originMarker.position.lat(), originMarker.position.lng(), destMarker.position.lat(), destMarker.position.lng());
            });
            function updateBounds () {
              var bounds = new google.maps.LatLngBounds();
              if(originMarker.position != undefined)
                bounds.extend(originMarker.position);
              if(destMarker.position != undefined)
                bounds.extend(destMarker.position);
              map.fitBounds(bounds);
              if(map.getZoom()>15)
                map.setZoom(15);
            }
            setInterval(function() {
              if(originMarker.position != undefined && destMarker.position != undefined) {
                console.log("Recalculating");
                calculateRides(originMarker.position.lat(), originMarker.position.lng(), destMarker.position.lat(), destMarker.position.lng());
              }
            },30000);
            $("#refresh").click(function(){
                alert("button");
            });
          }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-6Jk4A4RtRg_H0Kd0cFci3Bg52c8gzAY&libraries=places&callback=initMap"
          async defer></script>
    </div>
  </div>
  <div class="panel panel-default">
    <div class="panel-heading">Fares
      <button id=refresh type="button" class="btn btn-default" aria-label="Right Align" style="float:right;" onclick="recalculate()">
        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
      </button>
    </div>
    <div class="panel-body">
      Fares calculated include any surge pricing. ETA is an estimate of how long it will take for the driver to pick you up. Fares recalculate every 30 seconds.
    </div>
    <table id=prices class="table table-striped" style="font-size:14;"><tr><td>Please select your destination</table>
    <div class="panel-footer" id=lastUpdated></div>
  </div>
</body>
